---
title: "QC and Table 1"
author: "Caleb Diaz"
date: "2025-06-09"
output: 
  html_document:
    code_folding: hide
    theme: flatly
runtime: shiny
---

# Load Data

Load data from cohort identification script. Select all patients that were on life support, when they started life support, when the 48 hour window began, which device they were on, and when the 48 hour window ended.

```{r setup, include = FALSE}
library(arrow)
library(shiny)
library(dplyr)
library(ggplot2)
library(tidyr)
library(stringr)
library(purrr)
library(DT)
library(duckdb)
library(lubridate)
library(fuzzyjoin)
library(data.table)
library(gt)
library(tibble)


# Set up environment
set.seed(42)
rm(list = ls())
knitr::opts_knit$set(root.dir = '/Users/cdiaz/Desktop/SRP/SRP SOFA/')
print(getwd())
print(file.exists("config/config.json"))

# Load data
data <- read_parquet("/Users/cdiaz/Desktop/SRP/SRP SOFA/output/intermediate/sofaclif_cohort.parquet")
head(data)

# Set up for DuckDB Connection

## DuckDB Helper function
read_data <- function(file_path) {
  if (grepl("\\.csv$", file_path)) {
    return(read.csv(file_path))
  } else if (grepl("\\.parquet$", file_path)) {
    return(arrow::read_parquet(file_path))
  } else if (grepl("\\.fst$", file_path)) {
    return(fst::read.fst(file_path))
  } else {
    stop("Unsupported file format")
  }
}

## DuckDB Writing Function
write_files_to_duckdb <- function(files, tables_location, file_type, con) {
  for (file_name in files) {
    file_path <- file.path(tables_location, paste0(file_name, file_type))
    data <- as.data.frame(read_data(file_path))
    table_name <- tools::file_path_sans_ext(file_name)
    duckdb::dbWriteTable(con, table_name, data, overwrite = TRUE)
    message("Wrote table: ", table_name, " from file: ", file_name)
    rm(data)
  }
}

## Needed tables
true_tables <- list("clif_medication_admin_continuous", "clif_patient",
                    "clif_hospitalization", "clif_adt", "clif_respiratory_support",
                    "clif_labs", "clif_vitals", "clif_patient_assessments")

# Access configuration parameters
source("/Users/cdiaz/Desktop/SRP/SRP SOFA/utils/config.R")

site_name <- config$site_name
tables_path <- config$tables_path
file_type <- config$file_type

con <- duckdb::dbConnect(duckdb::duckdb(), dbdir = ":memory:")
write_files_to_duckdb(true_tables, tables_path, file_type, con)

# Add meas_dttm column:

data <- data %>%
  mutate(
    # Create time string with leading zero for hour
    time_str = str_c(str_pad(meas_hour, 2, pad = "0"), "00", "00", sep = ":"),
    # Concatenate date and time for datetime_str
    datetime_str = str_c(meas_date, time_str, sep = " "),
    # Now parse as POSIXct
    meas_dttm = as.POSIXct(datetime_str, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
  ) %>%
  mutate(
    # Floor to the nearest hour
    life_support_start = floor_date(as.POSIXct(life_support_start, tz = "UTC"), unit = "hour"),
    meas_dttm = floor_date(meas_dttm, unit = "hour")
  ) %>%
  # Remove the helper columns
  select(-time_str, -datetime_str)

patients_on_support <- data %>% 
  filter(meas_dttm == life_support_start & on_life_support == 1) %>% 
  select(hospitalization_id, life_support_start, 
         window_start, window_end, device_filled, meas_dttm, on_life_support, life_support_reason)
```

## Labs

Load labs file. Select `lab_category, lab_result_dttm, lab_value_numeric`. Ensure that `lab_result_dttm` falls within window.

```{r message=FALSE, warning=FALSE}
required_labs <- c("po2_arterial", "bilirubin_total", "creatinine", "platelet_count")
labs_hosp <- patients_on_support %>% 
  left_join(tbl(con, "clif_labs"), by = "hospitalization_id", copy = TRUE) %>%
  filter(lab_category %in% required_labs) %>% 
  filter(lab_category == "po2_arterial" & lab_value_numeric > 30 & lab_value_numeric <= 800 |
           lab_category == "bilirubin_total" & lab_value_numeric > 0 & lab_value_numeric <= 50 |
           lab_category == "platelet_count" & lab_value_numeric > 0 & lab_value_numeric <= 832 |
           lab_category == "creatinine" & lab_value_numeric > 0 & lab_value_numeric <= 30) %>%
  filter(lab_result_dttm >= window_start & lab_result_dttm <= window_end) %>% 
  collect()
```

## Vitals

Pull SpO2 and MAP from `clif_vitals`. Ensure that `recorded_dttm` is within window.

```{r message=FALSE, warning=FALSE}
required_vitals <- c("map", "spo2")

vitals_hosp <- patients_on_support %>% 
  left_join(tbl(con, "clif_vitals"), by = "hospitalization_id", copy = TRUE) %>% 
  filter(vital_category %in% required_vitals) %>% 
  filter(
    (vital_category == "spo2" & vital_value > 60 & vital_value <= 100) |
    (vital_category == "map" & vital_value > 0 & vital_value <= 300)
  ) %>%
  filter(recorded_dttm >= window_start & recorded_dttm <= window_end) %>%
  rename(recorded_dttm_vitals = recorded_dttm) %>% 
  collect()
```

## Medications

Pull vasoactives from `clif_medication_admin_continuous`. Ensure `admin_dttm` is within window.

```{r message=FALSE, warning=FALSE}
pressors_hosp <- patients_on_support %>% 
  left_join(tbl(con, "clif_medication_admin_continuous"), 
            by = "hospitalization_id", copy = TRUE) %>% 
  filter(med_group == "vasoactives") %>% 
  filter(admin_dttm >= window_start & admin_dttm <= window_end) %>% 
  collect()
```

## Assessments

Pull GCS score. Ensure `recorded_dttm` is within window.

```{r message = FALSE, warning=FALSE}
gcs_hosp <- patients_on_support %>% 
  left_join(tbl(con, "clif_patient_assessments"), by = "hospitalization_id", copy = TRUE) %>% 
  filter(assessment_category == "gcs_total") %>% 
  filter(numerical_value >= 0) %>% 
  filter(recorded_dttm >= window_start & recorded_dttm <= window_end) %>% 
  rename(recorded_dttm_assessments = recorded_dttm) %>% 
  collect()
```

## Respiratory Support

Pull `mode_category, lpm_set, fio2_set, peep_set, tidal_volume_set`. Clean `fio2_set` and add in approximations of `fio2_set` based on liters per minute. Filter out CPAP. Ensure `recorded_dttm` is within window. Add FiO2 approximations where applicable.

```{r message = FALSE, warning=FALSE}
# Load data
resp_support_hosp <- patients_on_support %>% 
  left_join(tbl(con, "clif_respiratory_support"), by = "hospitalization_id", copy = TRUE) %>% 
    filter(recorded_dttm >= window_start & 
             recorded_dttm <= window_end) %>% 
  select(hospitalization_id, recorded_dttm, mode_category, 
         device_category, lpm_set, fio2_set, peep_set, tidal_volume_set) %>% 
  filter(!(device_category == "CPAP" & (is.na(fio2_set) | fio2_set < 0.3))) %>% 
  mutate(fio2_set_clean = ifelse(fio2_set < 0.21 | fio2_set > 1, NA, fio2_set)) %>%
  rename(recorded_dttm_resp = recorded_dttm) %>% 
  collect()

# Create a new device category column.
resp_support_hosp <- resp_support_hosp %>% 
  mutate(device_category_2 = case_when(
    !is.na(device_category) ~ device_category,
    mode_category %in% c("SIMV", "Pressure-regulated Volume Control", "Assist Control-Volume Control") ~ "Vent",
    is.na(device_category) & fio2_set_clean == 0.21 & is.na(lpm_set) & is.na(peep_set) & is.na(tidal_volume_set) ~ "Room Air",
    is.na(device_category) & is.na(fio2_set_clean) & lpm_set == 0 & is.na(peep_set) & is.na(tidal_volume_set) ~ "Room Air",
    is.na(device_category) & is.na(fio2_set_clean) & lpm_set <= 20 & lpm_set > 0 & is.na(peep_set) & is.na(tidal_volume_set) ~ "Nasal Cannula",
    is.na(device_category) & is.na(fio2_set_clean) & lpm_set > 20 & is.na(peep_set) & is.na(tidal_volume_set) ~ "High Flow NC",
    device_category == "Nasal Cannula" & is.na(fio2_set_clean) & lpm_set > 20 ~ "High Flow NC",
    TRUE ~ device_category # Keep original device_category if no condition is met
  ))

# Add FiO2 approximations
fio2_lookup <- c(
  `1` = 0.24, `2` = 0.28, `3` = 0.32, `4` = 0.36, `5` = 0.40,
  `6` = 0.44, `7` = 0.48, `8` = 0.52, `9` = 0.56, `10` = 0.60
)

resp_support_hosp <- resp_support_hosp %>%
  mutate(fio2_approx = case_when(
    !is.na(fio2_set_clean) ~ fio2_set,
    is.na(fio2_set_clean) & device_category_2 == "Room Air" ~ 0.21,
    is.na(fio2_set_clean) & device_category_2 == "Nasal Cannula" ~ (0.21 + (0.04 * lpm_set)),
    is.na(fio2_set_clean) & device_category_2 == "High Flow NC" ~ (0.48 + ((lpm_set - 6) * 0.02)),
    is.na(fio2_set_clean) & device_category_2 %in% c("Vent", "NIPPV", "CPAP") ~ fio2_lookup[as.character(lpm_set)],
    TRUE ~ NA_real_
  ))
```

# Combine Data and Add Location

Combine all dataframes into one large dataframe. Use `clif_adt` to add `location_category` based on `event_time` and `in_dttm`/`out_dttm`. If `event_time` falls in between the ADT times, then pull the location category during that timeframe.

```{r}
# Standardize columns: hospitalization_id, event_time, variable_name, value, source

labs_long <- labs_hosp %>%
  select(hospitalization_id, event_time = lab_result_dttm, variable_name = lab_category, value = lab_value_numeric) %>%
  mutate(source = "labs")

vitals_long <- vitals_hosp %>%
  select(hospitalization_id, event_time = recorded_dttm_vitals, variable_name = vital_category, value = vital_value) %>%
  mutate(source = "vitals")

gcs_long <- gcs_hosp %>%
  select(hospitalization_id, event_time = recorded_dttm_assessments, variable_name = assessment_category, value = numerical_value) %>%
  mutate(source = "gcs")

meds_long <- pressors_hosp %>%
  select(hospitalization_id, event_time = admin_dttm, variable_name = med_category, value = med_dose) %>%
  mutate(source = "meds")

resp_long <- resp_support_hosp %>%
  select(hospitalization_id, event_time = recorded_dttm_resp, variable_name = device_category_2, value = fio2_approx) %>%
  mutate(source = "resp")

# Combine long
combined_long <- bind_rows(labs_long, vitals_long, gcs_long, meds_long, resp_long)

final_combined <- combined_long %>%
  left_join(patients_on_support, by = "hospitalization_id") %>% 
  arrange(hospitalization_id, event_time)

# Add in location by applying location_category based on in_dttm, out_dttm, and event_time. 
# i.e. if event_time falls in between in_dttm and out_dttm, then location_category should be in that row.

clif_adt <- tbl(con, "clif_adt") %>% collect()

setDT(final_combined)
setDT(clif_adt)

final_data <- copy(final_combined)
final_data[
  clif_adt,
  on = .(hospitalization_id, event_time >= in_dttm, event_time <= out_dttm),
  location_category := i.location_category
]

rm(clif_adt)
rm(combined_long)
rm(final_combined)
rm(gcs_hosp)
rm(gcs_long)
rm(labs_hosp)
rm(labs_long)
rm(meds_long)
rm(pressors_hosp)
rm(resp_long)
rm(resp_support_hosp)
rm(vitals_hosp)
rm(vitals_long)
```

# Plot Creation

First, create a time variable called `window_hour` which is negative when `event_time < life_support_start`, positive otherwise.

```{r message = FALSE, warning=FALSE}

# Cleaning up and adding additional needed variables
final_data <- as.data.frame(final_data)
final_data <- final_data %>%
  mutate(variable_name = if_else(source == "resp", 
                                 "fio2_approx", variable_name))

# Add in_hospital_mortality from data df
mortality_ids <- data %>%
  select(hospitalization_id, in_hospital_mortality) %>%
  distinct()

final_data <- final_data %>%
  left_join(mortality_ids, by = "hospitalization_id")

final_data <- final_data %>%
  mutate(event_time = as.POSIXct(event_time),
         life_support_start = as.POSIXct(life_support_start),
         window_hour = as.numeric(difftime(event_time, 
                                           life_support_start, units = "hours")))
```

Pull a sample of 100 hospitalization IDs.

```{r}
# Pull a sample of 100 unique hospitalization_ids
set.seed(42) # for reproducibility
sample_ids <- final_data %>%
  distinct(hospitalization_id) %>%
  sample_n(100) %>%
  pull(hospitalization_id)

# Create the new dataframe with only the data from sampled hospitalization_ids
sample_data <- final_data %>%
  filter(hospitalization_id %in% sample_ids)
```

First, determine the intervals that a location category spans. This will be used to create the shading objects in `ggplot2`. Second, define a function that creates the set of plots required for each hospitalization, defined by the unique values from the `variable_name` column.

```{r message = FALSE, warning=FALSE}
location_intervals <- sample_data %>%
  group_by(hospitalization_id, location_category) %>%
  summarize(
    start = min(window_hour, na.rm = TRUE),
    end = max(window_hour, na.rm = TRUE),
    .groups = "drop"
  )

create_patient_plots <- function(data, hospitalization_id) {
  patient_data <- data %>%
    filter(hospitalization_id == !!hospitalization_id)
  
  most_common_reason <- patient_data %>%
  count(life_support_reason) %>%
  arrange(desc(n)) %>%
  slice(1) %>%
  pull(life_support_reason)

  life_support_window_hour <- unique(
    patient_data$window_hour[which(patient_data$event_time == unique(patient_data$life_support_start))]
  )
  if (length(life_support_window_hour) == 0 || is.na(life_support_window_hour)) life_support_window_hour <- 0

  # Ensure variable column is called 'variable'
  long_data <- patient_data %>%
    rename(variable = variable_name)

  # Create continuous location intervals
  location_intervals <- long_data %>%
    arrange(window_hour) %>%
    select(window_hour, location_category) %>%
    distinct() %>%
    mutate(
      xmin = window_hour,
      xmax = lead(window_hour, default =
                    max(long_data$window_hour, na.rm = TRUE) + 1)) %>%
    select(location_category, xmin, xmax)

  plots <- long_data %>%
    split(.$variable) %>%
    map(function(.x) {
      max_y <- max(.x$value, na.rm = TRUE)
      label_y <- min(max_y * 0.95, max_y - 0.1 * abs(max_y))
      ggplot(.x, aes(x = window_hour, y = value)) +
        geom_rect(
          data = location_intervals,
          aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf, fill = location_category),
          inherit.aes = FALSE,
          alpha = 0.2
        ) +
        geom_point() +
        geom_vline(xintercept = life_support_window_hour, color = "red", linetype = "dashed") +
        annotate(
          "text",
          x = life_support_window_hour,
          y = label_y,
          label = most_common_reason,
          color = "red",
          angle = 90,
          vjust = -0.5,
          hjust = 0,
          size = 3,
          fontface = "bold"
        ) +
        scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
        labs(
          title = paste("Hospitalization", hospitalization_id, "-", unique(.x$variable)),
          x = "Window Hour", y = "Value") +
        theme_classic() +
        theme(
          axis.title.x = element_text(face = "bold"),
          axis.title.y = element_text(face = "bold"),
          text = element_text(family = "Arial"),
          plot.title = element_text(face = "bold")
        ) + 
        labs(fill = "Location Category")+
        theme(
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold"))
    })
  return(plots)
}

all_hosp_ids <- unique(sample_data$hospitalization_id)
# Matrix of plots to pull from
plot_matrix <- all_hosp_ids %>%
  set_names() %>%
  map(~ suppressWarnings(create_patient_plots(sample_data, .x)))
```

```{r controls_and_plot, echo = FALSE}

plot_vars <- unique(sample_data$variable_name)

# Controls
fluidRow(
  column(6, selectInput("plot_type", "Plot type:", choices = plot_vars)),
  column(6, selectInput("Hospitalization", "ID:", choices = all_hosp_ids))
)

renderPlot({
  req(input$Hospitalization, input$plot_type)
  plot_matrix[[input$Hospitalization]][[input$plot_type]]
})

renderDT({
  req(input$Hospitalization)
  filtered <- sample_data %>% filter(hospitalization_id == input$Hospitalization)
  max_device_filled <- max(filtered$device_filled, na.rm = TRUE)
  if (is.infinite(max_device_filled)) {
    max_device_filled <- NA
  }
  # Summarize statistics for each variable_name
  summary_df <- filtered %>%
    group_by(variable_name) %>%
    summarise(
      mean = mean(value, na.rm = TRUE),
      median = median(value, na.rm = TRUE),
      sd = sd(value, na.rm = TRUE),
      iqr = IQR(value, na.rm = TRUE),
      min = min(value, na.rm = TRUE),
      max = max(value, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(across(where(is.numeric), ~round(.x, 2))) %>%
    arrange(variable_name)
  
  datatable(
    summary_df,
    caption = paste0("Summary Table for Hospitalization ID: ",
                     input$Hospitalization, 
                     " | Most Utilized Device: ", max_device_filled),
    rownames = FALSE,
    options = list(pageLength = nrow(summary_df))
  )
})
```

# Histograms and Device Filled Chart

```{r histograms, echo = FALSE}
vars <- unique(final_data$variable_name)

# Create a named list of histogram plots
histogram_list <- map(vars, function(var) {
  ggplot(final_data %>% filter(variable_name == var), aes(x = value)) +
    geom_histogram(aes(y = after_stat(count / sum(count) * 100)), bins = 30, fill = "#2c7fb8", color = "white") +
    labs(
      title = paste("Histogram of", var),
      x = var,
      y = "Percent"
    ) +
    theme_minimal()
})
names(histogram_list) <- vars

# Device filled bar chart
device_filled_pct <- final_data %>%
  filter(!is.na(device_filled)) %>%
  count(device_filled) %>%
  mutate(percent = 100 * n / sum(n)) %>%
  arrange(desc(percent)) %>%
  mutate(device_filled = factor(device_filled, levels = device_filled)) # order factor by percent

life_support_reason_pct <- final_data %>%
  count(life_support_reason) %>%
  mutate(percent = 100 * n / sum(n)) %>%
  arrange(desc(percent)) %>%
  mutate(life_support_reason = factor(life_support_reason, levels = life_support_reason)) # order factor by percent

reason_chart <- ggplot(life_support_reason_pct, aes(x = life_support_reason, y = percent)) +
  geom_col(fill = "#2c7fb8") +
  geom_text(
    aes(label = sprintf("%.1f%%", percent)),
    vjust = -0.25,
    size = 4
  ) +
  labs(
    title = "Life Support Reason: Percent of Total (Sorted)",
    x = "Life Support Reason",
    y = "Percent"
  ) +
  theme_minimal()

device_filled_chart <- ggplot(device_filled_pct, aes(x = device_filled, y = percent)) +
  geom_col(fill = "#f03b20") +
  geom_text(
    aes(label = sprintf("%.1f%%", percent)),
    vjust = -0.25,
    size = 4
  ) +
  labs(
    title = "Device Filled: Percent of Total (Sorted)",
    x = "Device Filled",
    y = "Percent"
  ) +
  theme_minimal()
```

# Table 1

```{r table1}
library(dplyr)
library(tidyr)
library(kableExtra)
library(stringr)

# Helper for median (IQR)
med_iqr <- function(x) {
  x <- x[!is.na(x)]
  if (length(x) == 0) return(NA)
  paste0(formatC(median(x), digits=1, format="f"),
         " (", 
         formatC(quantile(x, 0.25), digits=1, format="f"), ", ",
         formatC(quantile(x, 0.75), digits=1, format="f"), ")")
}

# Summarize to hospitalization_id (ICU encounter) level
data_summary <- data %>%
  group_by(hospitalization_id) %>%
  summarise(
    patient_id = first(patient_id),
    in_hospital_mortality = first(in_hospital_mortality),
    sex_category = first(sex_category),
    race_category = first(race_category),
    ethnicity_category = first(ethnicity_category),
    age_at_admission = first(age_at_admission),
    p_f_imputed = median(p_f_imputed, na.rm = TRUE),
    s_f = median(s_f, na.rm = TRUE),
    min_plt_count = median(min_plt_count, na.rm = TRUE),
    max_bilirubin = median(max_bilirubin, na.rm = TRUE),
    min_map = median(min_map, na.rm = TRUE),
    dobutamine = median(dobutamine, na.rm = TRUE),
    dopamine = median(dopamine, na.rm = TRUE),
    norepinephrine = median(norepinephrine, na.rm = TRUE),
    gcs_total = median(gcs_total, na.rm = TRUE),
    max_creatinine = median(max_creatinine, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(Survival = ifelse(in_hospital_mortality == 0, "Survivor", "Non-Survivor"))

# Patient-level summary for demographics and survival
patient_summary <- data_summary %>%
  group_by(patient_id) %>%
  summarise(
    race_category = first(race_category),
    ethnicity_category = first(ethnicity_category),
    sex_category = first(sex_category),
    Survival = ifelse(any(in_hospital_mortality == 1), "Non-Survivor", "Survivor")
  )

# Life Support Reason table: one per encounter, from time of support start
ls_reason_lookup <- data %>%
  filter(life_support_start == meas_dttm) %>%
  select(hospitalization_id, life_support_reason) %>%
  distinct(hospitalization_id, .keep_all = TRUE) %>%
  left_join(data_summary %>% select(hospitalization_id, Survival), by = "hospitalization_id")

# Define new variable display names
var_display_names <- list(
  "p_f_imputed" = "PaO2/FiO2 (median, IQR)",
  "s_f" = "SpO2/FiO2 (median, IQR)",
  "min_plt_count" = "Platelet Count (median, IQR)",
  "max_bilirubin" = "Bilirubin (median, IQR)",
  "min_map" = "Mean Arterial Pressure (median, IQR)",
  "dobutamine" = "Dobutamine (median, IQR)",
  "dopamine" = "Dopamine (median, IQR)",
  "norepinephrine" = "Norepinephrine (median, IQR)",
  "gcs_total" = "Glasgow Coma Scale (median, IQR)",
  "max_creatinine" = "Creatinine (median, IQR)"
)

table1 <- list()

# Number of ICU Encounters (N)
icu_encounters <- data_summary %>%
  count(Survival)
table1[["ICU Encounters (N)"]] <- setNames(icu_encounters$n, icu_encounters$Survival)

# Number of Patients (N)
n_patients <- patient_summary %>%
  count(Survival)
table1[["Patients (N)"]] <- setNames(n_patients$n, n_patients$Survival)

# Sex (N, % female) at patient level
sex_pat <- patient_summary %>%
  group_by(Survival) %>%
  summarise(
    N_female = sum(sex_category == "Female", na.rm = TRUE),
    Percent_female = 100 * mean(sex_category == "Female", na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(Sex = paste0(N_female, " (", formatC(Percent_female, digits=1, format="f"), "%)"))
table1[["Sex (N, % Female)"]] <- setNames(sex_pat$Sex, sex_pat$Survival)

# Age (median, IQR) -- at encounter level, placed after Sex
age <- data_summary %>%
  group_by(Survival) %>%
  summarise(stat = med_iqr(age_at_admission), .groups = "drop")
table1[["Age (median, IQR)"]] <- setNames(
  c(ifelse("Survivor" %in% age$Survival, age$stat[age$Survival == "Survivor"], ""),
    ifelse("Non-Survivor" %in% age$Survival, age$stat[age$Survival == "Non-Survivor"], "")),
  c("Survivor", "Non-Survivor")
)

# Blank Race header row
table1[["Race (N, %)"]] <- c("", "")

race_levels <- c("White", "Asian", "Native Hawaiian or Other Pacific Islander", 
                 "Black or African American", "Unknown", "Other", "American Indian or Alaska Native")
race_tab <- patient_summary %>%
  filter(race_category %in% race_levels) %>%
  group_by(Survival, race_category) %>%
  summarise(N = n(), .groups = "drop") %>%
  group_by(Survival) %>%
  mutate(Total = sum(N),
         Percent = 100 * N / Total,
         Race = paste0(N, " (", formatC(Percent, digits=1, format="f"), "%)")) %>%
  ungroup() %>%
  select(Survival, race_category, Race) %>%
  pivot_wider(names_from = Survival, values_from = Race) %>%
  rename(Variable = race_category)

for (i in seq_along(race_levels)) {
  row <- race_tab[race_tab$Variable == race_levels[i],]
  # Just the formatted value, not the variable name
  table1[[paste0("  ", race_levels[i])]] <- setNames(
    c(ifelse("Survivor" %in% names(row), row[["Survivor"]], ""),
      ifelse("Non-Survivor" %in% names(row), row[["Non-Survivor"]], "")),
    c("Survivor", "Non-Survivor")
  )
}

# Blank Ethnicity header row
table1[["Ethnicity (N, %)"]] <- c("", "")
ethnicity_levels <- c("Hispanic", "Non-Hispanic", "Unknown")
eth_tab <- patient_summary %>%
  filter(ethnicity_category %in% ethnicity_levels) %>%
  group_by(Survival, ethnicity_category) %>%
  summarise(N = n(), .groups = "drop") %>%
  group_by(Survival) %>%
  mutate(Total = sum(N),
         Percent = 100 * N / Total,
         Eth = paste0(N, " (", formatC(Percent, digits=1, format="f"), "%)")) %>%
  ungroup() %>%
  select(Survival, ethnicity_category, Eth) %>%
  pivot_wider(names_from = Survival, values_from = Eth) %>%
  rename(Variable = ethnicity_category)

for (i in seq_along(ethnicity_levels)) {
  row <- eth_tab[eth_tab$Variable == ethnicity_levels[i],]
  table1[[paste0("  ", ethnicity_levels[i])]] <- setNames(
    c(ifelse("Survivor" %in% names(row), row[["Survivor"]], ""),
      ifelse("Non-Survivor" %in% names(row), row[["Non-Survivor"]], "")),
    c("Survivor", "Non-Survivor")
  )
}

# Numeric variables (median, IQR) with new names (still at encounter level)
numeric_vars <- c("p_f_imputed", "s_f", "min_plt_count", "max_bilirubin", "min_map",
                  "dobutamine", "dopamine", "norepinephrine", "gcs_total", "max_creatinine")
for (v in numeric_vars) {
  res <- data_summary %>%
    group_by(Survival) %>%
    summarise(stat = med_iqr(.data[[v]]), .groups = "drop")
  display_name <- var_display_names[[v]]
  table1[[display_name]] <- setNames(
    c(ifelse("Survivor" %in% res$Survival, res$stat[res$Survival == "Survivor"], ""),
      ifelse("Non-Survivor" %in% res$Survival, res$stat[res$Survival == "Non-Survivor"], "")),
    c("Survivor", "Non-Survivor")
  )
}

# Blank Life Support Reason header row
table1[["Life Support Reason (N, %)"]] <- c("", "")

lsr_tab <- ls_reason_lookup %>%
  filter(!is.na(life_support_reason)) %>%
  group_by(Survival, life_support_reason) %>%
  summarise(N = n(), .groups = "drop") %>%
  group_by(Survival) %>%
  mutate(
    Percent = 100 * N / sum(N),
    LS = paste0(N, " (", formatC(Percent, digits=1, format="f"), "%)")
  ) %>%
  ungroup() %>%
  select(Survival, life_support_reason, LS) %>%
  pivot_wider(names_from = Survival, values_from = LS) %>%
  rename(Variable = life_support_reason)

ls_levels <- unique(lsr_tab$Variable)
for (i in seq_along(ls_levels)) {
  row <- lsr_tab[lsr_tab$Variable == ls_levels[i],]
  table1[[paste0("  ", ls_levels[i])]] <- setNames(
    c(ifelse("Survivor" %in% names(row), row[["Survivor"]], ""),
      ifelse("Non-Survivor" %in% names(row), row[["Non-Survivor"]], "")),
    c("Survivor", "Non-Survivor")
  )
}

# Build the table in the desired order
desired_order <- c(
  "ICU Encounters (N)",
  "Patients (N)",
  "Sex (N, % Female)",
  "Age (median, IQR)",
  "Race (N, %)",
  paste0("  ", race_levels),
  "Ethnicity (N, %)",
  paste0("  ", ethnicity_levels),
  unname(unlist(var_display_names)),
  "Life Support Reason (N, %)",
  paste0("  ", ls_levels)
)

# Defensive extraction: always return blank if not found or not named
table1_df <- tibble::tibble(
  Variable = desired_order,
  Survivor = sapply(desired_order, function(x) {
    if (!is.null(table1[[x]]) && "Survivor" %in% names(table1[[x]])) table1[[x]][["Survivor"]] else
      if (!is.null(table1[[x]]) && length(table1[[x]]) == 2 && all(table1[[x]] == "")) "" else ""
  }),
  `Non-Survivor` = sapply(desired_order, function(x) {
    if (!is.null(table1[[x]]) && "Non-Survivor" %in% names(table1[[x]])) table1[[x]][["Non-Survivor"]] else
      if (!is.null(table1[[x]]) && length(table1[[x]]) == 2 && all(table1[[x]] == "")) "" else ""
  })
)

# Print with kableExtra, indenting sub-rows
table1_df %>%
  mutate(
    Variable = ifelse(str_detect(Variable, "^  "), paste0("&nbsp;&nbsp;", str_trim(Variable)), Variable)
  ) %>%
  kable("html", escape = FALSE, col.names = c("Variable", "Survivors", "Non-Survivors")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE) %>%
  scroll_box(width = "100%")
```
